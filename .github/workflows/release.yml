name: Build Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build Android APK
        run: ./gradlew :composeApp:assembleRelease --no-daemon

      - name: Verify APK file
        run: |
          echo "Checking APK files..."
          ls -lh composeApp/build/outputs/apk/release/ || echo "APK directory not found"
          find composeApp/build/outputs/apk/release -name "*.apk" || echo "No APK files found"

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: composeApp/build/outputs/apk/release/*.apk
          if-no-files-found: error
          retention-days: 30

  build-jvm-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build JVM Linux Distribution
        run: ./gradlew :composeApp:packageReleaseDistributionForCurrentOS --no-daemon

      - name: Find JVM Linux files
        run: |
          echo "Searching for Linux distribution files..."
          find composeApp/build/compose/binaries/main-release -type f | head -10

      - name: Upload JVM Linux Distribution
        uses: actions/upload-artifact@v4
        with:
          name: jvm-linux-distribution
          path: |
            composeApp/build/compose/binaries/main-release/deb/**/*
            composeApp/build/compose/binaries/main-release/**/*.deb
          if-no-files-found: error
          retention-days: 30

  build-jvm-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Build JVM Windows Distribution
        continue-on-error: true
        run: |
          # Собираем дистрибутив для Windows
          # Используем --stacktrace для лучшей диагностики при ошибках
          .\gradlew.bat :composeApp:packageReleaseDistributionForCurrentOS --no-daemon --stacktrace
          
          # Сохраняем код выхода
          $buildExitCode = $LASTEXITCODE
          
          # Если MSI не собрался, проверяем логи и пробуем альтернативы
          if ($buildExitCode -ne 0) {
            echo "Build failed with exit code $buildExitCode"
            echo "Checking error logs..."
            if (Test-Path "composeApp/build/compose/logs/packageReleaseMsi") {
              echo "=== MSI Error Log ==="
              Get-Content "composeApp/build/compose/logs/packageReleaseMsi/jpackage-*-err.txt" -ErrorAction SilentlyContinue | Select-Object -Last 100
              echo "=== MSI Output Log ==="
              Get-Content "composeApp/build/compose/logs/packageReleaseMsi/jpackage-*-out.txt" -ErrorAction SilentlyContinue | Select-Object -Last 100
            }
            
            # Пробуем собрать общую задачу packageRelease как fallback
            # Она соберет все доступные форматы для текущей ОС
            echo "Trying to build packageRelease as fallback..."
            .\gradlew.bat :composeApp:packageRelease --no-daemon
            if ($LASTEXITCODE -eq 0) {
              echo "packageRelease build succeeded!"
            } else {
              echo "packageRelease build also failed"
              # Если и это не работает, просто продолжаем - может быть собран runtime image
              echo "Continuing anyway to check for any built artifacts..."
            }
          } else {
            echo "Build succeeded!"
          }

      - name: Find JVM Windows files
        run: |
          echo "Searching for Windows distribution files..."
          if (Test-Path "composeApp/build/compose/binaries/main-release") {
            Get-ChildItem -Path composeApp/build/compose/binaries/main-release -Recurse -File | Select-Object FullName -First 10
          } else {
            echo "main-release directory not found, checking alternatives..."
            Get-ChildItem -Path composeApp/build/compose/binaries -Recurse -File | Select-Object FullName -First 10
          }
          echo ""
          echo "MSI files:"
          Get-ChildItem -Path composeApp/build/compose/binaries -Recurse -Filter "*.msi" | Select-Object FullName
          echo ""
          echo "EXE files:"
          Get-ChildItem -Path composeApp/build/compose/binaries -Recurse -Filter "*.exe" | Select-Object FullName

      - name: Verify Windows build artifacts
        run: |
          $foundFiles = $false
          if (Test-Path "composeApp/build/compose/binaries/main-release") {
            $msiFiles = Get-ChildItem -Path composeApp/build/compose/binaries/main-release -Recurse -Filter "*.msi" -ErrorAction SilentlyContinue
            $exeFiles = Get-ChildItem -Path composeApp/build/compose/binaries/main-release -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue
            
            if ($msiFiles) {
              echo "Found MSI files:"
              $msiFiles | ForEach-Object { echo "  $($_.FullName)" }
              $foundFiles = $true
            }
            if ($exeFiles) {
              echo "Found EXE files:"
              $exeFiles | ForEach-Object { echo "  $($_.FullName)" }
              $foundFiles = $true
            }
          }
          
          if (-not $foundFiles) {
            echo "Warning: No MSI or EXE files found!"
            echo "Checking all binaries..."
            Get-ChildItem -Path composeApp/build/compose/binaries -Recurse -File | Select-Object FullName -First 20
            # Не падаем, просто предупреждаем - может быть runtime image собран
            echo "No installers found, but continuing..."
          } else {
            echo "Build artifacts verified successfully"
          }

      - name: Upload JVM Windows Distribution
        uses: actions/upload-artifact@v4
        with:
          name: jvm-windows-distribution
          path: |
            composeApp/build/compose/binaries/main-release/msi/**/*
            composeApp/build/compose/binaries/main-release/**/*.msi
            composeApp/build/compose/binaries/main-release/**/*.exe
          if-no-files-found: warn
          retention-days: 30

  build-jvm-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build JVM macOS Distribution
        run: ./gradlew :composeApp:packageReleaseDistributionForCurrentOS --no-daemon

      - name: Find JVM macOS files
        run: |
          echo "Searching for macOS distribution files..."
          find composeApp/build/compose/binaries/main-release -type f | head -10

      - name: Upload JVM macOS Distribution
        uses: actions/upload-artifact@v4
        with:
          name: jvm-macos-distribution
          path: |
            composeApp/build/compose/binaries/main-release/dmg/**/*
            composeApp/build/compose/binaries/main-release/**/*.dmg
          if-no-files-found: error
          retention-days: 30

  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build iOS Framework
        env:
          GRADLE_OPTS: "-Xmx8192M -Xms2048M"
        run: ./gradlew :composeApp:linkReleaseFrameworkIosArm64 :composeApp:linkReleaseFrameworkIosSimulatorArm64 --no-daemon

      - name: Find iOS Framework files
        run: |
          echo "Searching for iOS frameworks..."
          find composeApp/build -name "*.framework" -type d 2>/dev/null | head -20

      - name: Build iOS IPA (without signing)
        run: |
          # Создаем директорию для сборки
          mkdir -p build/ios
          
          cd iosApp
          
          # Создаем архив с автоматической подписью (development)
          # Xcode автоматически создаст временный сертификат для разработки
          xcodebuild -project iosApp.xcodeproj \
            -scheme iosApp \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            -configuration Release \
            -archivePath ../build/ios/iosApp.xcarchive \
            -allowProvisioningUpdates \
            archive || echo "Archive creation completed with warnings"
          
          # Создаем ExportOptions.plist для development экспорта
          cat > ../build/ios/ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>development</string>
            <key>compileBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <false/>
            <key>uploadBitcode</key>
            <false/>
          </dict>
          </plist>
          EOF
          
          # Экспортируем IPA (development метод не требует App Store учетных данных)
          xcodebuild -exportArchive \
            -archivePath ../build/ios/iosApp.xcarchive \
            -exportPath ../build/ios/ipa \
            -exportOptionsPlist ../build/ios/ExportOptions.plist \
            -allowProvisioningUpdates || echo "IPA export completed with warnings"
          
          cd ..

      - name: Find iOS IPA files
        run: |
          echo "Searching for iOS IPA files..."
          find build/ios -name "*.ipa" 2>/dev/null || echo "No IPA files found"
          find iosApp/build -name "*.ipa" 2>/dev/null || echo "No IPA files in iosApp/build"

      - name: Upload iOS IPA
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: |
            build/ios/ipa/*.ipa
            iosApp/build/*.ipa
          if-no-files-found: warn
          retention-days: 30

  # build-js:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #
  #     - name: Setup JDK
  #       uses: actions/setup-java@v4
  #       with:
  #         java-version: '17'
  #         distribution: 'temurin'
  #
  #     - name: Setup Gradle
  #       uses: gradle/gradle-build-action@v2
  #
  #     - name: Make gradlew executable
  #       run: chmod +x ./gradlew
  #
  #     - name: Upgrade Yarn Lock (optional)
  #       run: ./gradlew kotlinUpgradeYarnLock --no-daemon || true
  #
  #     - name: Build JS Distribution
  #       run: ./gradlew :composeApp:jsBrowserDistribution --no-daemon
  #
  #     - name: Upload JS Distribution
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: js-distribution
  #         path: composeApp/build/dist/js/productionExecutable
  #         if-no-files-found: error
  #         retention-days: 30

  build-wasm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Upgrade Yarn Lock (optional)
        run: ./gradlew kotlinUpgradeYarnLock --no-daemon || true

      - name: Build WASM Distribution
        run: ./gradlew :composeApp:wasmJsBrowserDistribution --no-daemon

      - name: Verify WASM files
        run: |
          echo "Checking WASM distribution..."
          if [ -d "composeApp/build/dist/wasmJs/productionExecutable" ]; then
            echo "WASM directory found:"
            ls -lh composeApp/build/dist/wasmJs/productionExecutable/ | head -10
            echo "Total files: $(find composeApp/build/dist/wasmJs/productionExecutable -type f | wc -l)"
          else
            echo "WASM directory not found!"
            find composeApp/build/dist -type d 2>/dev/null | head -10
          fi

      - name: Upload WASM Distribution
        uses: actions/upload-artifact@v4
        with:
          name: wasm-distribution
          path: composeApp/build/dist/wasmJs/productionExecutable
          if-no-files-found: error
          retention-days: 30

  create-release:
    needs: [build-android, build-jvm-linux, build-jvm-windows, build-jvm-macos, build-ios, build-wasm]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            TAG_NAME="${{ github.ref_name }}"
          else
            TAG_NAME="${{ github.event.inputs.version }}"
          fi
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Tag name: $TAG_NAME"

      - name: List artifacts
        run: |
          echo "Artifacts structure:"
          find artifacts -type f | head -30
          echo ""
          echo "APK files:"
          find artifacts -name "*.apk" | head -5
          echo ""
          echo "MSI files:"
          find artifacts -name "*.msi" | head -5
          echo ""
          echo "WASM directory:"
          ls -la artifacts/wasm-distribution 2>/dev/null || echo "WASM directory not found"
          echo ""
          echo "iOS IPA files:"
          find artifacts -name "*.ipa" | head -5

      - name: Prepare release files
        run: |
          # Создаем список уникальных файлов для загрузки
          mkdir -p release_files
          
          # Копируем APK
          find artifacts -name "*.apk" -exec cp {} release_files/ \;
          
          # Копируем JVM дистрибутивы (msi, dmg, deb, exe)
          find artifacts -name "*.msi" -o -name "*.dmg" -o -name "*.deb" -o -name "*.exe" | while read file; do
            cp "$file" release_files/
          done
          
          # Копируем iOS IPA файлы
          find artifacts -name "*.ipa" -exec cp {} release_files/ \;
          
          # Упаковываем WASM в zip архив 
          # В GitLab: zip -r "./outFiles/productionExecutable-$VERSION.zip" ./composeApp/build/dist/wasmJs/productionExecutable/
          if [ -d "artifacts/wasm-distribution" ]; then
            cd artifacts/wasm-distribution
            zip -r ../../release_files/wasm-distribution.zip . -q
            cd ../..
            echo "WASM packaged: wasm-distribution.zip ($(du -h release_files/wasm-distribution.zip | cut -f1))"
          else
            echo "Warning: wasm-distribution directory not found in artifacts"
            find artifacts -type d -name "*wasm*" | head -5
          fi
          
          # JS закомментирован, не упаковываем
          
          echo "Release files prepared:"
          ls -lh release_files/
          echo ""
          echo "File count:"
          find release_files -type f | wc -l

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          files: |
            release_files/*.apk
            release_files/*.msi
            release_files/*.dmg
            release_files/*.deb
            release_files/*.exe
            release_files/*.ipa
            release_files/*.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
