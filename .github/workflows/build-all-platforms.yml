name: Build All Platforms

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
    paths:
      - 'composeApp/**'
      - '.github/workflows/build-all-platforms.yml'

permissions:
  contents: read

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build Android APK
        run: ./gradlew :composeApp:assembleRelease --no-daemon

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: composeApp/build/outputs/apk/release/*.apk
          retention-days: 7

  build-jvm-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build JVM Linux Distribution
        run: ./gradlew :composeApp:packageReleaseDistributionForCurrentOS --no-daemon

      - name: Upload JVM Linux Distribution
        uses: actions/upload-artifact@v4
        with:
          name: jvm-linux-distribution
          path: composeApp/build/compose/binaries/main/release/**/*
          retention-days: 7

  build-jvm-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Build JVM Windows Distribution
        run: .\gradlew.bat :composeApp:packageReleaseDistributionForCurrentOS --no-daemon

      - name: Upload JVM Windows Distribution
        uses: actions/upload-artifact@v4
        with:
          name: jvm-windows-distribution
          path: composeApp/build/compose/binaries/main/release/**/*
          retention-days: 7

  build-jvm-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build JVM macOS Distribution
        run: ./gradlew :composeApp:packageReleaseDistributionForCurrentOS --no-daemon

      - name: Upload JVM macOS Distribution
        uses: actions/upload-artifact@v4
        with:
          name: jvm-macos-distribution
          path: composeApp/build/compose/binaries/main/release/**/*
          retention-days: 7

  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build iOS Framework
        run: ./gradlew :composeApp:linkDebugFrameworkIosArm64 :composeApp:linkDebugFrameworkIosSimulatorArm64 --no-daemon

      - name: Upload iOS Framework
        uses: actions/upload-artifact@v4
        with:
          name: ios-framework
          path: composeApp/build/framework/**/*
          retention-days: 7

  build-js:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Upgrade Yarn Lock
        run: ./gradlew kotlinUpgradeYarnLock --no-daemon

      - name: Build JS Distribution
        run: ./gradlew :composeApp:jsBrowserDistribution --no-daemon

      - name: Upload JS Distribution
        uses: actions/upload-artifact@v4
        with:
          name: js-distribution
          path: composeApp/build/dist/js/productionExecutable
          retention-days: 7

  build-wasm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Upgrade Yarn Lock
        run: ./gradlew kotlinUpgradeYarnLock --no-daemon

      - name: Build WASM Distribution
        run: ./gradlew :composeApp:wasmJsBrowserDistribution --no-daemon

      - name: Upload WASM Distribution
        uses: actions/upload-artifact@v4
        with:
          name: wasm-distribution
          path: composeApp/build/dist/wasmJs/productionExecutable
          retention-days: 7

